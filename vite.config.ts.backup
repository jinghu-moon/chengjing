import { fileURLToPath, URL } from 'node:url'
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import svgLoader from 'vite-svg-loader'
import AutoImport from 'unplugin-auto-import/vite'
import Components from 'unplugin-vue-components/vite'
import { viteStaticCopy } from 'vite-plugin-static-copy'
import extensionReloader from './scripts/reloader'

// ===== ç¯å¢ƒå˜é‡ =====
const isDev = process.env.WATCH === 'true'
const reloaderPort = process.env.RELOADER_PORT ? parseInt(process.env.RELOADER_PORT) : 8888

// ğŸ” è°ƒè¯•ï¼šéªŒè¯ä¼˜åŒ–æ˜¯å¦ç”Ÿæ•ˆ
console.log('[Vite Config] isDev:', isDev)
console.log('[Vite Config] minify:', isDev ? false : 'esbuild')
console.log('[Vite Config] sourcemap:', isDev ? true : false)
console.log('[Vite Config] target:', isDev ? 'esnext' : 'modules')

// https://vitejs.dev/config/
export default defineConfig({
  // âœ… å‡å°‘å¼€å‘æ¨¡å¼ä¸‹çš„å†—ä½™æ—¥å¿—
  logLevel: isDev ? 'warn' : 'info',

  // ğŸš€ ä¾èµ–é¢„æ„å»ºä¼˜åŒ–ï¼ˆå¼ºåˆ¶ç¼“å­˜é‡ä¾èµ–ï¼‰
  optimizeDeps: {
    include: [
      'vue',
      '@tiptap/vue-3',
      '@tiptap/starter-kit',
      'dayjs',
      'lowlight',
    ],
    // å¼€å‘æ—¶ä¿æŒä¾èµ–é¢„æ„å»ºç»“æœï¼Œé™¤éä¾èµ–å˜æ›´
    force: false,
  },

  plugins: [
    vue(),
    svgLoader({
      svgoConfig: {
        plugins: [
          {
            name: 'preset-default',
            params: {
              overrides: {
                // ä¿ç•™ viewBoxï¼Œå¦åˆ™ CSS å¤§å°æ§åˆ¶ä¼šå¤±æ•ˆ
                removeViewBox: false,
              },
            },
          },
          // ç§»é™¤ width/height å±æ€§ï¼Œè®©ç»„ä»¶çš„ CSS æ§åˆ¶å¤§å°
          'removeDimensions',
        ],
      },
    }),
    // è‡ªåŠ¨å¯¼å…¥ Vue API (ref, reactive, computed ç­‰) å’Œé¡¹ç›®å†…å‡½æ•°
    AutoImport({
      imports: ['vue'],
      dts: 'src/auto-imports.d.ts',
      // âœ… è‡ªåŠ¨æ‰«æç›®å½•ï¼Œå¯¼å…¥å¯¼å‡ºçš„å‡½æ•°
      dirs: [
        'src/composables', // è‡ªåŠ¨å¯¼å…¥æ‰€æœ‰ hooks (useSettings, useCalendar ç­‰)
        'src/utils', // è‡ªåŠ¨å¯¼å…¥å·¥å…·å‡½æ•° (throttle, positioning ç­‰)
      ],
      vueTemplate: true, // æ”¯æŒåœ¨ Vue æ¨¡æ¿ä¸­ä½¿ç”¨è‡ªåŠ¨å¯¼å…¥çš„å‡½æ•°
    }),
    // è‡ªåŠ¨å¯¼å…¥ç»„ä»¶
    Components({
      dirs: ['src/components'],
      dts: 'src/components.d.ts',
    }),
    // å¤åˆ¶ manifest.json åˆ° distï¼ˆChrome æ‰©å±•å¿…éœ€ï¼‰
    viteStaticCopy({
      targets: [{ src: 'src/manifest.json', dest: '.' }],
    }),
    // âœ… æ¡ä»¶å¯ç”¨è‡ªåŠ¨é‡è½½æ’ä»¶
    ...(isDev ? [extensionReloader({
      port: reloaderPort,
      smartReload: true,
      hotReloadCSS: true,
      showNotification: true,
      logLevel: 'info'
    })] : []),
  ],
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./src', import.meta.url)),
    },
  },
  build: {
    // âœ… æ ¹æ®ç¯å¢ƒå˜é‡å†³å®šæ˜¯å¦å¯ç”¨ watch
    watch: isDev ? {} : null,

    outDir: 'dist',
    emptyOutDir: true,
    // å¼€å‘æ—¶å…³é—­ CSS ä»£ç åˆ†å‰²ï¼Œå‡å°‘æ–‡ä»¶ç”Ÿæˆæ•°é‡
    cssCodeSplit: isDev ? false : true,
    // æ˜¾ç¤ºå‹ç¼©åçš„å¤§å°ï¼ˆå¼€å‘æ¨¡å¼å…³é—­ä»¥æå‡é€Ÿåº¦ï¼‰
    reportCompressedSize: !isDev,

    // ===== å¼€å‘ç¯å¢ƒä¼˜åŒ– =====
    minify: isDev ? false : 'esbuild', // å¼€å‘æ—¶ä¸å‹ç¼©ï¼ŒåŠ å¿«æ„å»ºé€Ÿåº¦
    sourcemap: isDev ? true : false, // å¼€å‘æ—¶ç”Ÿæˆç‹¬ç«‹ map æ–‡ä»¶ï¼ˆæ¯” inline æ›´å¿«ï¼‰
    target: isDev ? 'esnext' : 'modules', // å¼€å‘æ—¶ä½¿ç”¨ç°ä»£è¯­æ³•ï¼Œå‡å°‘è½¬è¯‘

    rollupOptions: {
      output: {
        // ç¡®ä¿æ‰“åŒ…åçš„æ–‡ä»¶åä¸å¸¦ hashï¼Œæ–¹ä¾¿ manifest å¼•ç”¨ï¼ˆå¯é€‰ï¼Œä½†åœ¨æ’ä»¶å¼€å‘ä¸­æ¨èï¼‰
        entryFileNames: 'assets/[name].js',
        chunkFileNames: 'assets/[name].js',
        assetFileNames: 'assets/[name].[ext]',
        // å¼€å‘æ—¶å…³é—­æ‰‹åŠ¨åˆ†åŒ…ï¼ŒåŠ å¿«æ„å»ºé€Ÿåº¦
        manualChunks: isDev ? undefined : (id) => {
          if (id.includes('node_modules')) {
            if (
              id.includes('@tiptap') ||
              id.includes('prosemirror') ||
              id.includes('tiptap-markdown')
            ) {
              return 'vendor-editor'
            }
            // lowlight ä»£ç é«˜äº®å•ç‹¬åˆ†åŒ…
            if (id.includes('lowlight')) {
              return 'vendor-highlight'
            }
            if (id.includes('dayjs') || id.includes('chinese-days')) {
              return 'vendor-date'
            }
            if (id.includes('vue') || id.includes('@vue')) {
              return 'vendor-core'
            }
            if (id.includes('@tabler/icons-vue')) {
              return 'vendor-icons'
            }
            // è™šæ‹Ÿæ»šåŠ¨å•ç‹¬åˆ†åŒ…
            if (id.includes('@tanstack/vue-virtual')) {
              return 'vendor-virtual'
            }
          }
        },
      },
    },
  },
})
